worker_processes auto;
events { worker_connections 1024; }

http {
    include      mime.types;
    default_type application/octet-stream;
    sendfile     on;
    keepalive_timeout 65;

    # basic gzip
    gzip on;
    gzip_types text/plain text/css application/json application/javascript application/xml;
    gzip_min_length 1024;

    # derive/propagate a request id
    # if client sends X-Request-ID, use it; otherwise generate a uuid
    map $http_x_request_id $req_id {
        default $http_x_request_id;
        ""      $request_id; # $request_id is nginx's internal unique ID
    }

    # structured JSON access log
    log_format json escape=json
      '{'
        '"ts":"$time_iso8601",'
        '"remote_addr":"$remote_addr",'
        '"method":"$request_method",'
        '"path":"$uri",'
        '"query":"$args",'
        '"status":"$status",'
        '"bytes":"$body_bytes_sent",'
        '"referer":"$http_referer",'
        '"user_agent":"$http_user_agent",'
        '"request_time":"$request_time",'
        '"upstream_time":"$upstream_response_time",'
        '"request_id":"$req_id",'
        '"host":"$host",'
        '"service":"notes-nginx"'
      '}';

    # send access logs to container stdout; errors to stderr
    # write to both stdout and a file
    access_log /dev/stdout json;
    access_log /var/log/nginx/access.jsonl json;
    error_log /var/log/nginx/error.log info;

    # upstream points to the app container
    upstream fastapi_app {
        server app:8000; # service name from docker-compose
    }

    server {
        listen 80;
        server_name _;

        # client size limits (bump if you upload bigger payloads)
        client_max_body_size 2m;

        # Always return the request id to clients
        add_header X-Request-ID $req_id always;

        location / {
            proxy_pass http://fastapi_app;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Request-ID $req_id;
            proxy_read_timeout 60s;
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
        }

        location /docs { proxy_pass http://fastapi_app; proxy_set_header X-Request-ID $req_id; }
        location /openapi.json { proxy_pass http://fastapi_app; proxy_set_header X-Request-ID $req_id; }
        location /redoc { proxy_pass http://fastapi_app; proxy_set_header X-Request-ID $req_id; }
    }
}
